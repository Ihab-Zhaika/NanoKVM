name: Build NanoKVM preview artifacts

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      build_os_image:
        description: 'Build flashable OS image (requires more time and resources)'
        required: false
        default: false
        type: boolean

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  # RISC-V musl toolchain for Go cross-compilation
  MUSL_TOOLCHAIN_URL: https://musl.cc/riscv64-linux-musl-cross.tgz
  # Base NanoKVM OS image for creating flashable images
  BASE_IMAGE_URL: https://github.com/sipeed/NanoKVM/releases/download/NanoKVM/20240702_NanoKVM_Rev1_0_0.img.xz
  # Go version for building the server
  GO_VERSION: '1.24'

jobs:
  build:
    name: Build NanoKVM components
    runs-on: ubuntu-latest
    env:
      KVMAPP_WEB_PATH: server/web

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            gcc-riscv64-linux-gnu \
            patchelf \
            xz-utils \
            kpartx \
            parted

      - name: Download and setup RISC-V musl toolchain
        run: |
          echo "Downloading RISC-V musl cross-compiler toolchain..."
          curl -L "$MUSL_TOOLCHAIN_URL" | tar xz
          echo "$PWD/riscv64-linux-musl-cross/bin" >> $GITHUB_PATH

      - name: Verify toolchains
        run: |
          echo "GNU toolchain:"
          riscv64-linux-gnu-gcc --version
          echo ""
          echo "Musl toolchain:"
          riscv64-linux-musl-gcc --version

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: server/go.sum

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: web/pnpm-lock.yaml

      - name: Install frontend dependencies
        working-directory: web
        run: pnpm install --frozen-lockfile

      - name: Build frontend
        working-directory: web
        run: pnpm build

      - name: Build Go backend server
        working-directory: server
        run: |
          echo "Building NanoKVM-Server for RISC-V 64-bit..."
          export CGO_ENABLED=1
          export GOOS=linux
          export GOARCH=riscv64
          export CC="riscv64-linux-musl-gcc"
          export CGO_CFLAGS="-mcpu=c906fdv -march=rv64imafdcv0p7xthead -mcmodel=medany -mabi=lp64d"
          
          go build -o NanoKVM-Server -v
          
          if [ -f "NanoKVM-Server" ]; then
            echo "Binary built successfully"
            file NanoKVM-Server
            # Patch RPATH for dynamic library loading
            patchelf --add-rpath '$ORIGIN/dl_lib' NanoKVM-Server
            echo "RPATH patched successfully"
          else
            echo "Build failed - binary not found"
            exit 1
          fi

      - name: Build EDID update utility
        working-directory: tools/nanokvm_update_edid
        run: |
          make clean
          make

      - name: Assemble kvmapp update package
        run: |
          mkdir -p output
          KVMAPP_ROOT=output/kvmapp
          WEB_SUBDIR=${KVMAPP_WEB_PATH:-server/web}
          WEB_ROOT="$KVMAPP_ROOT/$WEB_SUBDIR"
          SERVER_ROOT="$KVMAPP_ROOT/server"
          
          # Copy base kvmapp structure
          mkdir -p "$KVMAPP_ROOT"
          cp -r kvmapp/. "$KVMAPP_ROOT"
          
          # Add web frontend
          mkdir -p "$WEB_ROOT"
          echo "Packaging web assets into $WEB_ROOT"
          cp -r web/dist/. "$WEB_ROOT"
          
          # Add server binary and dependencies
          mkdir -p "$SERVER_ROOT"
          cp server/NanoKVM-Server "$SERVER_ROOT/"
          if [ -d "server/dl_lib" ]; then
            cp -r server/dl_lib "$SERVER_ROOT/"
          fi
          
          # Copy server config files if they exist
          for cfg in server/config/*.yaml server/config/*.yml; do
            [ -f "$cfg" ] && cp "$cfg" "$SERVER_ROOT/" || true
          done
          
          # Create version file
          echo "dev-$(git rev-parse --short HEAD)" > "$KVMAPP_ROOT/version"
          
          # Set executable permissions
          chmod +x "$KVMAPP_ROOT/kvm_system/"* 2>/dev/null || true
          chmod +x "$SERVER_ROOT/NanoKVM-Server"
          chmod +x "$KVMAPP_ROOT/system/init.d/"* 2>/dev/null || true
          
          # Add tools
          mkdir -p output/tools
          cp tools/nanokvm_update_edid/nanokvm_update_edid output/tools/
          
          # Create update package (similar to official releases)
          echo "Creating kvmapp update package..."
          tar -czf nanokvm-kvmapp-update.tar.gz -C output/kvmapp .
          
          # Create full artifacts package
          tar -czf nanokvm-artifacts.tar.gz -C output .
          
          echo "Build artifacts created successfully"
          ls -la *.tar.gz

      - name: Upload kvmapp update package
        uses: actions/upload-artifact@v4
        with:
          name: nanokvm-kvmapp-${{ github.sha }}
          path: nanokvm-kvmapp-update.tar.gz
          if-no-files-found: error

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nanokvm-build-${{ github.sha }}
          path: |
            nanokvm-artifacts.tar.gz
            web/dist
            server/NanoKVM-Server
            tools/nanokvm_update_edid/nanokvm_update_edid
          if-no-files-found: error

  build-os-image:
    name: Build flashable OS image
    needs: build
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.build_os_image }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install image tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y \
            xz-utils \
            kpartx \
            parted \
            e2fsprogs \
            dosfstools

      - name: Download kvmapp artifact
        uses: actions/download-artifact@v4
        with:
          name: nanokvm-kvmapp-${{ github.sha }}
          path: ./artifacts

      - name: Download base NanoKVM OS image
        run: |
          echo "Downloading base NanoKVM OS image..."
          curl -L -o base-image.img.xz "$BASE_IMAGE_URL"
          echo "Extracting image..."
          xz -d base-image.img.xz
          echo "Base image ready"
          ls -la base-image.img

      - name: Inject kvmapp into OS image
        run: |
          set -e
          
          # Setup loop device for the image
          echo "Setting up loop device..."
          LOOP_DEV=$(sudo losetup --find --show --partscan base-image.img)
          echo "Loop device: $LOOP_DEV"
          
          # Wait for partitions to appear
          sleep 2
          
          # List partitions
          echo "Partitions:"
          sudo fdisk -l "$LOOP_DEV"
          
          # Find the rootfs partition (usually partition 2)
          ROOTFS_PART="${LOOP_DEV}p2"
          if [ ! -b "$ROOTFS_PART" ]; then
            echo "Trying kpartx..."
            sudo kpartx -av base-image.img
            ROOTFS_PART="/dev/mapper/$(basename $LOOP_DEV)p2"
          fi
          
          # Mount rootfs
          echo "Mounting rootfs partition..."
          mkdir -p mnt/rootfs
          sudo mount "$ROOTFS_PART" mnt/rootfs
          
          # Backup existing kvmapp
          if [ -d "mnt/rootfs/kvmapp" ]; then
            echo "Backing up existing kvmapp..."
            sudo mv mnt/rootfs/kvmapp mnt/rootfs/kvmapp.bak
          fi
          
          # Extract new kvmapp
          echo "Installing new kvmapp..."
          sudo mkdir -p mnt/rootfs/kvmapp
          sudo tar -xzf artifacts/nanokvm-kvmapp-update.tar.gz -C mnt/rootfs/kvmapp
          
          # Set permissions
          sudo chmod -R 755 mnt/rootfs/kvmapp
          
          # Verify installation
          echo "Verifying installation..."
          ls -la mnt/rootfs/kvmapp/
          
          # Cleanup
          echo "Cleaning up..."
          sudo umount mnt/rootfs
          sudo losetup -d "$LOOP_DEV" 2>/dev/null || true
          sudo kpartx -d base-image.img 2>/dev/null || true
          
          echo "kvmapp injection complete"

      - name: Compress final OS image
        run: |
          echo "Compressing final OS image..."
          VERSION="dev-$(echo ${{ github.sha }} | cut -c1-7)"
          OUTPUT_NAME="nanokvm-os-${VERSION}.img"
          mv base-image.img "$OUTPUT_NAME"
          xz -9 -T0 "$OUTPUT_NAME"
          
          echo "Final image created:"
          ls -la "${OUTPUT_NAME}.xz"
          
          # Generate checksum
          sha256sum "${OUTPUT_NAME}.xz" > "${OUTPUT_NAME}.xz.sha256"
          cat "${OUTPUT_NAME}.xz.sha256"

      - name: Upload OS image
        uses: actions/upload-artifact@v4
        with:
          name: nanokvm-os-image-${{ github.sha }}
          path: |
            nanokvm-os-*.img.xz
            nanokvm-os-*.img.xz.sha256
          if-no-files-found: error
